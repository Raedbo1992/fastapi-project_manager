from sqlalchemy import create_engine, MetaData
from sqlalchemy.schema import CreateIndex
import os

local_engine = create_engine(
    "postgresql+psycopg2://project_user:project123@localhost:5432/project_manager",
    client_encoding="utf8"
)

sql_file = "database_schema.sql"

print(f"ğŸ“¤ Exportando esquema a {sql_file}...")

metadata = MetaData()
metadata.reflect(bind=local_engine)

with open(sql_file, 'w', encoding='utf-8') as f:
    f.write("SET session_replication_role = 'replica';\n\n")

    for table in metadata.sorted_tables:
        f.write(f"-- Tabla: {table.name}\n")
        f.write(str(table.compile(local_engine)) + ";\n\n")

        # ğŸ”¹ ÃNDICES (forma correcta)
        for index in table.indexes:
            f.write(str(CreateIndex(index).compile(local_engine)) + ";\n")

        f.write("\n")

    f.write("SET session_replication_role = 'origin';\n")

print(f"âœ… Esquema exportado a {sql_file}")
print(f"ğŸ“ TamaÃ±o: {os.path.getsize(sql_file)} bytes")

{% extends "base_layout.html" %}

{% block title %}游늶 Mis Gastos{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='style_gastos_listado.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


{% endblock %}

{% block content %}
<div class="gastos-header">
  <h2><i class="bi bi-cash-stack"></i> Mis Gastos</h2>
  <a href="/gastos/nuevo" class="btn-nuevo">
    <i class="bi bi-plus-circle"></i> Nuevo Gasto
  </a>
</div>

<!-- Filtros -->
<div class="filtros-container">
  <form method="get" action="/gastos" class="filtros-form">
    
    <!-- Filtro Tipo -->
    <div class="filtro-item">
      <i class="bi bi-funnel"></i>
      <select name="tipo" onchange="this.form.submit()">
        <option value="">Todos los tipos</option>
        <option value="fijo" {% if filtro_tipo=='fijo' %}selected{% endif %}>Fijos</option>
        <option value="variable" {% if filtro_tipo=='variable' %}selected{% endif %}>Variables</option>
        <option value="opcional" {% if filtro_tipo=='opcional' %}selected{% endif %}>Opcionales</option>
      </select>
    </div>

    <!-- Filtro Estado -->
    <div class="filtro-item">
      <i class="bi bi-check2-circle"></i>
      <select name="pagado" onchange="this.form.submit()">
        <option value="">Todos los estados</option>
        <option value="true" {% if filtro_pagado==True %}selected{% endif %}>Pagados</option>
        <option value="false" {% if filtro_pagado==False %}selected{% endif %}>Pendientes</option>
      </select>
    </div>

  </form>
</div>


<div class="tabla-scroll">
  <table class="tabla-gastos">
    <thead>
      <tr>
        <th>Categor칤a</th>
        <th>Valor</th>
        <th>Fecha L칤mite</th>
        <th>Estado</th>
        <th>Notas</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for gasto in gastos %}
      <tr class="{% if gasto.pagado %}pagado{% else %}pendiente{% endif %}">
        <td class="categoria-cell-inline">
        <span class="categoria-nombre">{{ gasto.categoria.nombre }}</span>
        <span class="tipo-badge {{ gasto.categoria.tipo }}">
          {{ gasto.categoria.tipo }}
        </span>
      </td>

        <td>${{ "{:,.0f}".format(gasto.valor) }}</td>
        <td>{{ gasto.fecha_limite.strftime('%d/%m/%Y') if gasto.fecha_limite else '-' }}</td>
        <td>
          <span class="estado-badge {% if gasto.pagado %}pagado{% else %}pendiente{% endif %}">
            {% if gasto.pagado %}Pagado{% else %}Pendiente{% endif %}
          </span>
        </td>
        <td>{{ gasto.notas or '-' }}</td>
        <td class="acciones">
          <a href="/gastos/editar/{{ gasto.id }}" class="btn-icon edit">
            <i class="bi bi-pencil"></i>
          </a>
          <a href="/gastos/eliminar/{{ gasto.id }}" 
             class="btn-icon delete eliminar-btn" 
             data-id="{{ gasto.id }}">
            <i class="bi bi-trash"></i>
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ... (c칩digo existente) -->

<!-- Paginaci칩n Mejorada -->
{% if total_pages > 1 %}
<div class="paginacion">
    <!-- Bot칩n Anterior -->
    <a href="?page={% if current_page > 1 %}{{ current_page - 1 }}{% else %}1{% endif %}{% if filtro_tipo %}&tipo={{ filtro_tipo }}{% endif %}{% if filtro_pagado is not none %}&pagado={{ filtro_pagado }}{% endif %}" 
       class="pag-btn {% if current_page == 1 %}disabled{% endif %}"
       {% if current_page == 1 %}aria-disabled="true"{% endif %}>
        <i class="bi bi-chevron-left"></i>
    </a>

    <!-- P치gina 1 siempre visible -->
    <a href="?page=1{% if filtro_tipo %}&tipo={{ filtro_tipo }}{% endif %}{% if filtro_pagado is not none %}&pagado={{ filtro_pagado }}{% endif %}" 
       class="pag-btn {% if current_page == 1 %}active{% endif %}">
        1
    </a>

    <!-- Puntos suspensivos si hay muchas p치ginas -->
    {% if current_page > 3 %}
    <span class="pag-btn disabled">...</span>
    {% endif %}

    <!-- P치ginas alrededor de la actual -->
    {% for p in range([2, current_page-1]|max, [current_page+2, total_pages]|min) %}
        <a href="?page={{ p }}{% if filtro_tipo %}&tipo={{ filtro_tipo }}{% endif %}{% if filtro_pagado is not none %}&pagado={{ filtro_pagado }}{% endif %}" 
           class="pag-btn {% if p == current_page %}active{% endif %}">
            {{ p }}
        </a>
    {% endfor %}

    <!-- Puntos suspensivos finales si es necesario -->
    {% if current_page < total_pages - 2 %}
    <span class="pag-btn disabled">...</span>
    {% endif %}

    <!-- 칔ltima p치gina siempre visible -->
    {% if total_pages > 1 %}
    <a href="?page={{ total_pages }}{% if filtro_tipo %}&tipo={{ filtro_tipo }}{% endif %}{% if filtro_pagado is not none %}&pagado={{ filtro_pagado }}{% endif %}" 
       class="pag-btn {% if current_page == total_pages %}active{% endif %}">
        {{ total_pages }}
    </a>
    {% endif %}

    <!-- Bot칩n Siguiente -->
    <a href="?page={% if current_page < total_pages %}{{ current_page + 1 }}{% else %}{{ total_pages }}{% endif %}{% if filtro_tipo %}&tipo={{ filtro_tipo }}{% endif %}{% if filtro_pagado is not none %}&pagado={{ filtro_pagado }}{% endif %}" 
       class="pag-btn {% if current_page == total_pages %}disabled{% endif %}"
       {% if current_page == total_pages %}aria-disabled="true"{% endif %}>
        <i class="bi bi-chevron-right"></i>
    </a>
</div>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".eliminar-btn").forEach(function(btn) {
    btn.addEventListener("click", function(e) {
      e.preventDefault();
      const gastoId = btn.dataset.id;
      Swal.fire({
        title: '쮼liminar gasto?',
        text: "Esta acci칩n no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'S칤, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = `/gastos/eliminar/${gastoId}`;
        }
      });
    });
  });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function() {
  {% if mensaje %}
    Swal.fire({
      title: '{{ mensaje.titulo }}',
      text: '{{ mensaje.texto }}',
      icon: '{{ mensaje.tipo }}',
      confirmButtonColor: '#3085d6'
    });
  {% endif %}
});
</script>

{% endblock %}

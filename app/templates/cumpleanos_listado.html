{% extends "base_layout.html" %}

{% block title %}游꾹 Cumplea침os{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='style_cumpleanos_listado.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
{% endblock %}

{% block content %}
<div class="cumpleanos-header">
  <h2><i class="bi bi-cake2"></i> Gesti칩n de Cumplea침os</h2>
  <a href="/cumpleanos/nuevo" class="btn-nuevo">
    <i class="bi bi-plus-circle"></i> Nuevo Cumplea침os
  </a>
</div>

<!-- Filtros -->
<div class="filtros-container">
  <form method="get" action="/cumpleanos" class="filtros-form">
    <div class="filtro-item">
      <i class="bi bi-funnel"></i>
      <select name="relacion" onchange="this.form.submit()">
        <option value="">Todas las relaciones</option>
        <option value="Familia" {% if filtro_relacion=='Familia' %}selected{% endif %}>Familia</option>
        <option value="Amigo" {% if filtro_relacion=='Amigo' %}selected{% endif %}>Amigos</option>
        <option value="Trabajo" {% if filtro_relacion=='Trabajo' %}selected{% endif %}>Trabajo</option>
        <option value="Otro" {% if filtro_relacion=='Otro' %}selected{% endif %}>Otro</option>
      </select>
    </div>
  </form>
</div>

<div class="tabla-scroll">
  <table class="tabla-cumpleanos">
    <thead>
      <tr>
        <th>Persona</th>
        <th>Fecha Nacimiento</th>
        <th>Edad que cumplir치</th>
        <th>Pr칩ximo cumplea침os</th>
        <th>D칤as hasta cumplea침os</th>
        <th>Relaci칩n</th>
        <th>Contacto</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody>
      {% for cumple in cumpleanos %}
      <tr class="{% if cumple.dias_hasta_cumpleanos <= 7 %}proximo{% endif %}">
        <td>
          <div class="persona-info">
            <i class="bi bi-person-circle"></i>
            <strong>{{ cumple.nombre_persona }}</strong>
          </div>
        </td>
        <td>{{ cumple.fecha_nacimiento.strftime('%d/%m/%Y') }}</td>
      <td>{{ cumple.edad }} a침os</td>
        <td>{{ cumple.proximo_cumple.strftime('%d/%m/%Y') }}</td>
        <td>
          <span class="dias-badge {% if cumple.dias_hasta_cumpleanos == 0 %}hoy{% elif cumple.dias_hasta_cumpleanos <= 7 %}proximo{% endif %}">
            {% if cumple.dias_hasta_cumpleanos == 0 %}
              游꿀 춰HOY!
            {% elif cumple.dias_hasta_cumpleanos == 1 %}
              Ma침ana
            {% else %}
              En {{ cumple.dias_hasta_cumpleanos }} d칤as
            {% endif %}
          </span>
        </td>

        <td>
          {% if cumple.relacion %}
            <span class="relacion-badge {{ cumple.relacion|lower }}">{{ cumple.relacion }}</span>
          {% else %}
            -
          {% endif %}
        </td>
        <td>
          <div class="contacto-info">
            {% if cumple.telefono %}<div><i class="bi bi-phone"></i> {{ cumple.telefono }}</div>{% endif %}
            {% if cumple.email %}<div><i class="bi bi-envelope"></i> {{ cumple.email }}</div>{% endif %}
            {% if not cumple.telefono and not cumple.email %}-{% endif %}
          </div>
        </td>
        <td class="acciones">
          <a href="/cumpleanos/editar/{{ cumple.id }}" class="btn-icon edit">
            <i class="bi bi-pencil"></i>
          </a>
          <a href="/cumpleanos/eliminar/{{ cumple.id }}" 
             class="btn-icon delete eliminar-btn" 
             data-id="{{ cumple.id }}">
            <i class="bi bi-trash"></i>
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- Paginaci칩n -->
{% if total_pages > 1 %}
<div class="paginacion">
    <a href="?page={% if current_page > 1 %}{{ current_page - 1 }}{% else %}1{% endif %}{% if filtro_relacion %}&relacion={{ filtro_relacion }}{% endif %}" 
       class="pag-btn {% if current_page == 1 %}disabled{% endif %}">
        <i class="bi bi-chevron-left"></i>
    </a>

    <a href="?page=1{% if filtro_relacion %}&relacion={{ filtro_relacion }}{% endif %}" 
       class="pag-btn {% if current_page == 1 %}active{% endif %}">1</a>

    {% if current_page > 3 %}
    <span class="pag-btn disabled">...</span>
    {% endif %}

    {% for p in range([2, current_page-1]|max, [current_page+2, total_pages]|min) %}
        <a href="?page={{ p }}{% if filtro_relacion %}&relacion={{ filtro_relacion }}{% endif %}" 
           class="pag-btn {% if p == current_page %}active{% endif %}">{{ p }}</a>
    {% endfor %}

    {% if current_page < total_pages - 2 %}
    <span class="pag-btn disabled">...</span>
    {% endif %}

    {% if total_pages > 1 %}
    <a href="?page={{ total_pages }}{% if filtro_relacion %}&relacion={{ filtro_relacion }}{% endif %}" 
       class="pag-btn {% if current_page == total_pages %}active{% endif %}">{{ total_pages }}</a>
    {% endif %}

    <a href="?page={% if current_page < total_pages %}{{ current_page + 1 }}{% else %}{{ total_pages }}{% endif %}{% if filtro_relacion %}&relacion={{ filtro_relacion }}{% endif %}" 
       class="pag-btn {% if current_page == total_pages %}disabled{% endif %}">
        <i class="bi bi-chevron-right"></i>
    </a>
</div>
{% endif %}

<script>
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll(".eliminar-btn").forEach(function(btn) {
    btn.addEventListener("click", function(e) {
      e.preventDefault();
      const cumpleId = btn.dataset.id;
      Swal.fire({
        title: '쮼liminar cumplea침os?',
        text: "Esta acci칩n no se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'S칤, eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = `/cumpleanos/eliminar/${cumpleId}`;
        }
      });
    });
  });
});
</script>
{% endblock %}
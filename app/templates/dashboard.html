{% extends "base_layout.html" %}

{% block title %}Dashboard - Mis Finanzas{% endblock %}

{% block head %}
<link rel="stylesheet" href="/static/style_dashboard.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
{% endblock %}

{% block content %}
<div class="dashboard">
  <div class="dashboard-header">
    <h1>Resumen Financiero - {{ fecha_actual.strftime('%B %Y') }}</h1>
    <div class="user-info">
      <p>Bienvenido, {{ usuario.nombre }}</p>
      <small>Última actualización: {{ fecha_actual.strftime('%d/%m/%Y %H:%M') }}</small>
    </div>
  </div>

  <div class="bloques-dashboard">

    <div class="bloque resumen">
      <div class="resumen-card ingresos">
        <h3>Ingresos</h3>
        <p>${{ "{:,.0f}".format(stats.total_ingresos) }}</p>
      </div>

      <div class="resumen-card gastos">
        <h3>Gastos</h3>
        <p>${{ "{:,.0f}".format(stats.total_gastos) }}</p>
      </div>

      <div class="resumen-card saldo">
        <h3>Saldo</h3>
        <p>${{ "{:,.0f}".format(stats.saldo_disponible) }}</p>
      </div>
    </div>

    <div class="bloque grafico-container">
      <h3>Gastos por Categoría</h3>
      <canvas id="graficoCategorias"></canvas>
    </div>

    <div class="bloque grafico-container">
      <h3>Evolución Mensual</h3>
      <canvas id="graficoEvolucion"></canvas>
    </div>

  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const categorias = {{ stats.gastos_por_categoria|tojson }};
  const ctx1 = document.getElementById("graficoCategorias");

  if (ctx1) {
    new Chart(ctx1, {
      type: "doughnut",
      data: {
        labels: Object.keys(categorias),
        datasets: [{
          data: Object.values(categorias),
          borderWidth: 1
        }]
      },
      options: { responsive: true }
    });
  }

  const evolucion = {{ stats.evolucion_mensual.ingresos|tojson }};
  const labels = {{ stats.evolucion_mensual.labels|tojson }};
  const ctx2 = document.getElementById("graficoEvolucion");

  if (ctx2) {
    new Chart(ctx2, {
      type: "line",
      data: {
        labels: labels,
        datasets: [{
          label: "Ingresos",
          data: evolucion,
          tension: 0.3,
          fill: true
        }]
      },
      options: { responsive: true }
    });
  }

});
</script>

{% endblock %}
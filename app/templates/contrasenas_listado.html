{% extends "base_layout.html" %}

{% block title %}Gestión de Contraseñas{% endblock %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', path='style_contrasenas_listado.css') }}">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
{% endblock %}

{% block content %}
<div class="page-container">
  
  <!-- Header -->
  <div class="contrasenas-header">
    <h2><i class="bi bi-shield-lock"></i> Gestión de Contraseñas</h2>
    <a href="/contrasenas/nuevo" class="btn-nuevo">
      <i class="bi bi-plus-circle"></i> Nueva
    </a>
  </div>

  <!-- Mensajes -->
  {% if mensaje %}
  <div class="alert alert-{{ mensaje.tipo }}">
    <strong>{{ mensaje.titulo }}</strong> {{ mensaje.texto }}
  </div>
  {% endif %}

  <!-- Hint de scroll -->
  <div class="scroll-hint">
    <i class="bi bi-arrow-left-right"></i> Desliza para ver más
  </div>

  <!-- Tabla -->
  <div class="tabla-wrapper">
    <div class="tabla-scroll">
      <table class="tabla-contrasenas">
        <thead>
          <tr>
            <th class="sticky-col">Servicio</th>
            <th>Usuario</th>
            <th>Contraseña</th>
            <th>URL</th>
            <th>Notas</th>
            <th class="sticky-actions acciones-header">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% if contrasenas %}
            {% for contrasena in contrasenas %}
            <tr>
              <!-- Servicio -->
              <td class="sticky-col">
                <div class="servicio-content">
                  <span class="servicio-text" 
                        onclick="openTextModal('Servicio', '{{ contrasena.servicio }}')"
                        title="{{ contrasena.servicio }}">
                    {{ contrasena.servicio }}
                  </span>
                  <button class="btn-copy" 
                          onclick="copiarAlPortapapeles('{{ contrasena.servicio }}', 'Servicio', this)"
                          data-tooltip="Copiar servicio">
                    <i class="bi bi-copy"></i>
                  </button>
                </div>
              </td>
              
              <!-- Usuario -->
              <td>
                <div class="usuario-content">
                  <i class="bi bi-person usuario-icon"></i>
                  <span class="usuario-text"
                        onclick="openTextModal('Usuario', '{{ contrasena.usuario }}')"
                        title="{{ contrasena.usuario }}">
                    {{ contrasena.usuario }}
                  </span>
                  <button class="btn-copy"
                          onclick="copiarAlPortapapeles('{{ contrasena.usuario }}', 'Usuario', this)"
                          data-tooltip="Copiar usuario">
                    <i class="bi bi-copy"></i>
                  </button>
                </div>
              </td>
              
              <!-- Contraseña -->
              <td>
                <div class="password-container">
                  <div class="password-display">
                    <span id="contrasena-{{ contrasena.id }}" class="password-text">
                      ••••••••
                    </span>
                  </div>
                  <div class="password-actions">
                    <button class="btn-password btn-show"
                            onclick="togglePassword({{ contrasena.id }}, this)"
                            data-tooltip="Mostrar/Ocultar">
                      <i class="bi bi-eye"></i>
                    </button>
                    <button class="btn-password btn-modal"
                            onclick="viewFullPassword({{ contrasena.id }})"
                            data-tooltip="Ver completa">
                      <i class="bi bi-arrows-fullscreen"></i>
                    </button>
                    <button class="btn-password btn-copy-password"
                            onclick="copyPasswordDirectly({{ contrasena.id }}, this)"
                            data-tooltip="Copiar contraseña">
                      <i class="bi bi-copy"></i>
                    </button>
                  </div>
                </div>
              </td>
              
              <!-- URL -->
              <td>
                {% if contrasena.url %}
                <div class="url-content">
                  <i class="bi bi-link-45deg url-icon"></i>
                  <div class="url-text-container">
                    <span class="url-text"
                          onclick="openTextModal('URL', '{{ contrasena.url }}')"
                          title="{{ contrasena.url }}">
                      {{ contrasena.url|truncate(20) }}
                    </span>
                  </div>
                  <button class="btn-copy" 
                          onclick="copiarAlPortapapeles('{{ contrasena.url }}', 'URL', this)"
                          data-tooltip="Copiar URL">
                    <i class="bi bi-copy"></i>
                  </button>
                </div>
                {% else %}
                <span class="no-url">-</span>
                {% endif %}
              </td>
              
              <!-- Notas -->
              <td>
                <div class="notas-content">
                  <div class="notas-text-container">
                    <span class="notas-text">
                      {% if contrasena.notas %}
                        {{ contrasena.notas[:40] }}
                        {% if contrasena.notas|length > 40 %}
                          <button class="btn-ver-mas" 
                                  onclick="openTextModal('Notas', '{{ contrasena.notas }}')">
                            ver más
                          </button>
                        {% endif %}
                      {% else %}
                        -
                      {% endif %}
                    </span>
                  </div>
                  {% if contrasena.notas %}
                  <button class="btn-copy" 
                          onclick="copiarAlPortapapeles('{{ contrasena.notas }}', 'Notas', this)"
                          data-tooltip="Copiar notas">
                    <i class="bi bi-copy"></i>
                  </button>
                  {% endif %}
                </div>
              </td>
              
              <!-- Acciones - ESTILO IDÉNTICO A INGRESOS -->
              <td class="sticky-actions acciones-cell">
                <div class="acciones">
                  <a href="/contrasenas/editar/{{ contrasena.id }}" 
                     class="btn-icon edit" 
                     title="Editar">
                    <i class="bi bi-pencil-fill"></i>
                  </a>
                  <a href="/contrasenas/eliminar/{{ contrasena.id }}" 
                     class="btn-icon delete eliminar-btn" 
                     data-id="{{ contrasena.id }}"
                     title="Eliminar"
                     onclick="return confirmDelete(event, {{ contrasena.id }})">
                    <i class="bi bi-trash-fill"></i>
                  </a>
                </div>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="no-data">
                <i class="bi bi-inbox"></i>
                <div>No hay contraseñas guardadas</div>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Modal para texto completo -->
  <div id="text-modal" class="text-modal">
    <div class="text-modal-content">
      <div class="modal-header">
        <h3 id="modal-title"></h3>
        <button onclick="closeTextModal()" class="modal-close">
          &times;
        </button>
      </div>
      
      <div id="modal-content" class="modal-text-display"></div>
      
      <div class="modal-actions">
        <button onclick="copyFromModal()" class="btn-modal-copy">
          <i class="bi bi-copy"></i> Copiar
        </button>
        <button onclick="closeTextModal()" class="btn-modal-close">
          Cerrar
        </button>
      </div>
    </div>
  </div>

  <!-- Toast de notificación -->
  <div id="copy-toast" class="copy-toast">
    <div class="toast-content">
      <i class="bi bi-check-circle-fill"></i>
      <span id="toast-text"></span>
    </div>
  </div>

  <!-- Paginación -->
  {% if total_pages > 1 %}
  <div class="paginacion">
      
    <a href="?page={% if current_page > 1 %}{{ current_page - 1 }}{% else %}1{% endif %}" 
       class="pag-btn pag-nav {% if current_page == 1 %}disabled{% endif %}">
      <i class="bi bi-chevron-left"></i>
    </a>

    <div class="pag-info-mobile">
      {{ current_page }} / {{ total_pages }}
    </div>

    <div class="pag-numbers">
      <a href="?page=1" 
         class="pag-btn {% if current_page == 1 %}active{% endif %}">
        1
      </a>

      {% if current_page > 3 %}<span class="pag-dots">...</span>{% endif %}

      {% for p in range([2, current_page-1]|max, [current_page+2, total_pages]|min) %}
        <a href="?page={{ p }}" 
           class="pag-btn {% if p == current_page %}active{% endif %}">
          {{ p }}
        </a>
      {% endfor %}

      {% if current_page < total_pages - 2 %}<span class="pag-dots">...</span>{% endif %}

      {% if total_pages > 1 %}
      <a href="?page={{ total_pages }}" 
         class="pag-btn {% if current_page == total_pages %}active{% endif %}">
        {{ total_pages }}
      </a>
      {% endif %}
    </div>

    <a href="?page={% if current_page < total_pages %}{{ current_page + 1 }}{% else %}{{ total_pages }}{% endif %}" 
       class="pag-btn pag-nav {% if current_page == total_pages %}disabled{% endif %}">
      <i class="bi bi-chevron-right"></i>
    </a>
  </div>
  {% endif %}

</div>

<!-- JavaScript -->
<script>
document.addEventListener("DOMContentLoaded", function() {
  
  // Confirmar eliminación con SweetAlert (igual que ingresos)
  document.querySelectorAll(".eliminar-btn").forEach(function(btn) {
    btn.addEventListener("click", function(e) {
      e.preventDefault();
      Swal.fire({
        title: '¿Eliminar?',
        text: "No se puede deshacer",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#ef4444',
        cancelButtonColor: '#6b7280',
        confirmButtonText: 'Eliminar',
        cancelButtonText: 'Cancelar'
      }).then((result) => {
        if (result.isConfirmed) {
          window.location.href = `/contrasenas/eliminar/${btn.dataset.id}`;
        }
      });
    });
  });

  // Función para confirmar eliminación (mantener para compatibilidad)
  window.confirmDelete = function(event, id) {
    event.preventDefault();
    Swal.fire({
      title: '¿Eliminar?',
      text: "No se puede deshacer",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#ef4444',
      cancelButtonColor: '#6b7280',
      confirmButtonText: 'Eliminar',
      cancelButtonText: 'Cancelar'
    }).then((result) => {
      if (result.isConfirmed) {
        window.location.href = `/contrasenas/eliminar/${id}`;
      }
    });
    return false;
  };
  
  // Función para copiar texto
  window.copiarAlPortapapeles = function(texto, tipo, elemento) {
    if (!texto || texto === '-' || texto === '••••••••') return;
    
    navigator.clipboard.writeText(texto).then(() => {
      const toast = document.getElementById('copy-toast');
      const toastText = document.getElementById('toast-text');
      toastText.textContent = `${tipo} copiado al portapapeles`;
      toast.classList.add('show');
      
      if (elemento) {
        elemento.classList.add('copied');
        setTimeout(() => elemento.classList.remove('copied'), 1000);
      }
      
      setTimeout(() => toast.classList.remove('show'), 2000);
      
    }).catch(err => {
      console.error('Error al copiar:', err);
      alert('Error al copiar');
    });
  };
  
  // Mostrar/ocultar contraseña en línea
  window.togglePassword = async function(contrasenaId, button) {
    const span = document.getElementById(`contrasena-${contrasenaId}`);
    const icon = button.querySelector('i');
    
    if (span.textContent === '••••••••') {
      try {
        button.classList.add('loading');
        
        const response = await fetch(`/contrasenas/obtener/${contrasenaId}`);
        const data = await response.json();
        
        if (data.status === 'success') {
          span.textContent = data.contrasena;
          span.classList.add('visible');
          icon.classList.remove('bi-eye');
          icon.classList.add('bi-eye-slash');
          
          setTimeout(() => {
            if (span.textContent !== '••••••••') {
              span.textContent = '••••••••';
              span.classList.remove('visible');
              icon.classList.remove('bi-eye-slash');
              icon.classList.add('bi-eye');
            }
          }, 15000);
        }
      } catch (error) {
        console.error('Error:', error);
        alert('Error de conexión');
      } finally {
        button.classList.remove('loading');
      }
    } else {
      span.textContent = '••••••••';
      span.classList.remove('visible');
      icon.classList.remove('bi-eye-slash');
      icon.classList.add('bi-eye');
    }
  };
  
  // Abrir modal para texto completo
  window.openTextModal = function(titulo, contenido, type = 'texto') {
    const modal = document.getElementById('text-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalContent = document.getElementById('modal-content');
    
    modalTitle.textContent = titulo;
    if (type === 'password') {
      modalContent.innerHTML = `<div class="password-modal-display">${contenido}</div>`;
    } else {
      modalContent.textContent = contenido;
    }
    
    modal.style.display = 'flex';
  };
  
  // Cerrar modal
  window.closeTextModal = function() {
    document.getElementById('text-modal').style.display = 'none';
  };
  
  // Copiar del modal
  window.copyFromModal = function() {
    const content = document.getElementById('modal-content');
    const text = content.textContent || content.innerText;
    copiarAlPortapapeles(text, 'Texto', null);
  };
  
  // Copiar contraseña directamente
  window.copyPasswordDirectly = async function(contrasenaId, button) {
    try {
      button.classList.add('loading');
      
      const response = await fetch(`/contrasenas/obtener/${contrasenaId}`);
      const data = await response.json();
      
      if (data.status === 'success') {
        copiarAlPortapapeles(data.contrasena, 'Contraseña', button);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error de conexión');
    } finally {
      button.classList.remove('loading');
    }
  };
  
  // Ver contraseña completa en modal
  window.viewFullPassword = async function(contrasenaId) {
    try {
      const response = await fetch(`/contrasenas/obtener/${contrasenaId}`);
      const data = await response.json();
      
      if (data.status === 'success') {
        openTextModal('Contraseña Completa', data.contrasena, 'password');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error de conexión');
    }
  };
  
  // Event listeners para scroll hint (igual que ingresos)
  const scrollHint = document.querySelector('.scroll-hint');
  const tablaScroll = document.querySelector('.tabla-scroll');
  
  if (tablaScroll && scrollHint) {
    tablaScroll.addEventListener('scroll', () => {
      scrollHint.style.opacity = '0';
      setTimeout(() => scrollHint.remove(), 300);
    }, { once: true });
    
    setTimeout(() => {
      if (scrollHint) {
        scrollHint.style.opacity = '0';
        setTimeout(() => scrollHint.remove(), 300);
      }
    }, 4000);
  }
  
  // Cerrar modal con Escape
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      closeTextModal();
    }
  });
  
  // Cerrar modal al hacer clic fuera
  document.getElementById('text-modal').addEventListener('click', function(e) {
    if (e.target === this) {
      closeTextModal();
    }
  });
});
</script>
{% endblock %}